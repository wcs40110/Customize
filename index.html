<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Shady Creek Design Co.</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f9f9f9;
      display: flex;
      justify-content: center;
      align-items: flex-start; /* Align to top for longer content */
      min-height: 100vh;
    }

    .container {
      max-width: 600px;
      width: 100%;
      margin: 20px; /* Added margin for spacing */
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    h2 {
      text-align: center;
      color: #333;
    }

    label {
      display: block;
      margin-top: 15px;
      font-weight: bold;
      color: #555;
    }

    input[type="text"],
    textarea,
    select {
      width: 100%;
      padding: 12px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1em;
      box-sizing: border-box; /* Important for width calculation */
      transition: border-color 0.3s ease;
    }

    input[type="text"]:focus,
    textarea:focus,
    select:focus {
      border-color: #333;
      outline: none;
    }

    textarea {
      resize: vertical; /* Allow vertical resize */
    }

    button[type="submit"] {
      width: 100%;
      padding: 12px;
      margin-top: 25px;
      background-color: #333;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 1.1em;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    button[type="submit"]:hover {
      background-color: #555;
    }

    #svgPreview {
      margin-top: 25px;
      border: 1px dashed #ddd; /* Dashed border for preview */
      min-height: 150px;
      background: #f0f0f0; /* Slightly different background */
      padding: 10px;
      display: flex; /* For centering content if needed */
      justify-content: center;
      align-items: center;
      border-radius: 6px;
      overflow: auto; /* Handle large SVGs */
    }

    #svgPreview svg {
        max-width: 100%;
        height: auto;
    }

    #popupOverlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7); /* Darker overlay */
      color: white;
      font-size: 1.2em;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      text-align: center;
      padding: 20px;
      cursor: pointer; /* Indicate it's dismissible */
    }
    /* Basic alert styling for when opentype.js fails */
    .critical-error-display {
      color: red;
      font-weight: bold;
      padding: 10px;
      border: 1px solid red;
      background-color: #ffe0e0;
      border-radius: 6px;
      text-align: center;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/opentype.js@latest/dist/opentype.min.js"></script>
</head>
<body>

<div class="container">
  <h2>Shady Creek Design Co.</h2>
  <form id="customForm" onsubmit="event.preventDefault(); handleSubmit();">
    <label for="customerInput">Customer Name</label>
    <input type="text" id="customerInput" required>

    <label for="descInput">Item Description</label>
    <input type="text" id="descInput" required>

    <label for="locationInput">Engraving Location</label>
    <input type="text" id="locationInput" required>

    <label for="textInput">Text to Engrave</label>
    <textarea id="textInput" rows="3" required></textarea>

    <label for="fontSelector">Font</label>
    <select id="fontSelector">
      <option value="Satisfy">Satisfy</option>
      <option value="Righteous">Righteous</option>
      <option value="Grand Hotel">Grand Hotel</option>
      <option value="Short Stack">Short Stack</option>
      <option value="Love Ya Like A Sister">Love Ya Like A Sister</option>
      <option value="Ribeye Marrow">Ribeye Marrow</option>
    </select>

    <button type="submit">Generate & Download SVG</button>
  </form>

  <div id="svgPreview">Enter text above to preview.</div>
</div>

<div id="popupOverlay" onclick="this.style.display='none'">
  <div> SVG Downloaded!<br><small>(Click anywhere to dismiss)</small>
  </div>
</div>

<script>
  // IMMEDIATE CHECK FOR OPENTYPE.JS
  if (typeof opentype === 'undefined') {
    console.error("CRITICAL: opentype.js library did NOT load!");
    // Display error prominently on the page
    document.addEventListener('DOMContentLoaded', () => {
      const previewDiv = document.getElementById('svgPreview');
      if (previewDiv) {
        previewDiv.innerHTML = "<div class='critical-error-display'>CRITICAL ERROR: opentype.js library failed to load. This is essential for font operations. Please check your browser's Network tab in the developer tools for errors related to 'opentype.min.js'. Ensure your internet connection is active and not blocking cdn.jsdelivr.net.</div>";
      }
      // Disable form
      const form = document.getElementById('customForm');
      if (form) {
        form.querySelectorAll('input, textarea, select, button').forEach(el => el.disabled = true);
        const submitButton = form.querySelector('button[type="submit"]');
        if (submitButton) submitButton.textContent = "Feature Disabled (Font Library Error)";
      }
    });
  } else {
    console.log("SUCCESS: opentype.js library seems to be loaded.");
  }

  // Updated fontUrls to use relative paths
  // Ensure these filenames EXACTLY match the files in your repository (case-sensitive)
  const fontUrls = {
    "Satisfy": "./Satisfy-Regular.ttf",
    "Righteous": "./Righteous-Regular.ttf",
    "Grand Hotel": "./GrandHotel-Regular.ttf",
    "Short Stack": "./ShortStack-Regular.ttf",
    "Love Ya Like A Sister": "./LoveYaLikeASister-Regular.ttf",
    "Ribeye Marrow": "./RibeyeMarrow-Regular.ttf"
  };

  let loadedFont = null;
  let currentFontName = null;

  async function loadFont(fontName) {
    console.log(`[loadFont] Attempting to load font: ${fontName}`);
    // Do not proceed if opentype.js is not loaded. The initial check handles disabling the UI.
    if (typeof opentype === 'undefined') {
      const errorMsg = "[loadFont] CRITICAL: opentype.js is not defined. Cannot proceed.";
      console.error(errorMsg);
      // The UI should already be showing the critical error.
      throw new Error("opentype.js is not defined inside loadFont.");
    }

    if (fontName === currentFontName && loadedFont) {
      console.log(`[loadFont] Using cached font: ${fontName}`);
      return;
    }

    const url = fontUrls[fontName];
    if (!url) {
      const errorMsg = `[loadFont] Font URL not found for: ${fontName}`;
      console.error(errorMsg);
      document.getElementById('svgPreview').innerHTML = `<div style="color: red;">Configuration error: Font key '${fontName}' not found.</div>`;
      throw new Error(errorMsg);
    }

    console.log(`[loadFont] Fetching URL: ${url}`);
    try {
      const res = await fetch(url);
      console.log(`[loadFont] Fetch response for ${fontName}: Status ${res.status}, OK: ${res.ok}`);
      if (!res.ok) {
        throw new Error(`HTTP error! status: ${res.status} for ${url}. Ensure font file exists at this relative path ('${url}') and was deployed.`);
      }
      const fontBuffer = await res.arrayBuffer();
      console.log(`[loadFont] Font buffer received for ${fontName}, length: ${fontBuffer.byteLength} bytes.`);
      if (fontBuffer.byteLength < 1000) { // Real fonts are usually several KBs
          console.warn(`[loadFont] WARNING: Font buffer for ${fontName} is very small (${fontBuffer.byteLength} bytes). Is the font file correct/complete?`);
      }
      loadedFont = opentype.parse(fontBuffer);
      console.log(`[loadFont] Font parsed successfully: ${fontName}`);
      currentFontName = fontName;
    } catch (error) {
      console.error(`[loadFont] Failed to load or parse font '${fontName}' from '${url}':`, error);
      document.getElementById('svgPreview').innerHTML = `<div style="color: red;">Error loading font '${fontName}': ${error.message}. Check console for details.</div>`;
      throw error;
    }
  }

  function createSvg(text, font) {
    const fontSize = 80;
    const width = 600; // Desired SVG width
    const height = 150; // Desired SVG height

    let fontFamilyName = "Unknown";
    if (font && font.names && font.names.fontFamily && font.names.fontFamily.en) {
        fontFamilyName = font.names.fontFamily.en;
    } else if (font && font.familyName) {
        fontFamilyName = font.familyName;
    }
    console.log(`[createSvg] Creating SVG for text "${text}" with font ${fontFamilyName}`);

    // Get path and its bounding box to help with centering
    const path = font.getPath(text, 0, 0, fontSize);
    const boundingBox = path.getBoundingBox();
    const textWidth = boundingBox.x2 - boundingBox.x1;
    const textHeight = boundingBox.y2 - boundingBox.y1; // ascent - descent

    // Calculate x and y to center the text
    // For x: center the text block horizontally
    const x = (width - textWidth) / 2 - boundingBox.x1;
    // For y: For opentype.js, y=0 is the baseline.
    // To vertically center, we can adjust based on ascent/descent or a fixed offset.
    // This positions the baseline such that the text appears roughly centered.
    // A common approach is to position baseline at (SVG_height / 2) + (font_size / ~3 or ~4)
    // Or, more simply, adjust the viewBox. Here, we'll use a fixed y for baseline and adjust viewBox.
    const y = fontSize * 0.8; // Approximate y for baseline to appear centered in 150px height

    const pathData = font.getPath(text, x, y, fontSize).toPathData(2);

    const svgContent = `
      <svg xmlns="http://www.w3.org/2000/svg" width="${width}" height="${height}" viewBox="0 0 ${width} ${height}">
        <path d="${pathData}" fill="black"/>
      </svg>
    `;
    console.log("[createSvg] SVG markup generated.");
    return svgContent;
  }

  async function updatePreview() {
    console.log("[updatePreview] Called.");
    // Ensure opentype.js is loaded before trying to use it
    if (typeof opentype === 'undefined') {
        console.log("[updatePreview] opentype.js not loaded, skipping preview update.");
        return;
    }

    const text = document.getElementById('textInput').value.trim();
    const fontName = document.getElementById('fontSelector').value;
    const preview = document.getElementById('svgPreview');

    if (!text) {
      preview.innerHTML = "Enter text above to preview.";
      console.log("[updatePreview] No text, preview set to instruction.");
      return;
    }

    preview.innerHTML = `Loading font '${fontName}' and generating preview...`;
    console.log(`[updatePreview] Text: "${text}", Font: "${fontName}"`);
    try {
      await loadFont(fontName);
      if (!loadedFont) {
          console.error("[updatePreview] loadedFont is null after await loadFont(fontName).");
          throw new Error("Font could not be loaded or parsed successfully.");
      }
      const svgMarkup = createSvg(text, loadedFont);
      preview.innerHTML = svgMarkup;
      console.log("[updatePreview] SVG preview updated.");
    } catch (err) {
      console.error("[updatePreview] Error during preview update:", err);
      if (preview.innerHTML.includes("Loading font")) {
        preview.innerHTML = `<div style="color: red;">Failed to update preview: ${err.message}. Check console.</div>`;
      }
    }
  }

  async function handleSubmit() {
    console.log("[handleSubmit] Form submitted.");
    // Ensure opentype.js is loaded
     if (typeof opentype === 'undefined') {
        alert("Font processing library not loaded. Cannot generate SVG.");
        return;
    }

    const customer = document.getElementById('customerInput').value.trim();
    const desc = document.getElementById('descInput').value.trim();
    const location = document.getElementById('locationInput').value.trim();
    const text = document.getElementById('textInput').value.trim();
    const fontName = document.getElementById('fontSelector').value;

    if (!text) {
        // Using a custom modal/message box instead of alert
        const popup = document.getElementById('popupOverlay');
        popup.innerHTML = '<div>Enter some text to generate SVG.<br><small>(Click to dismiss)</small></div>';
        popup.style.display = 'flex';
        console.log("[handleSubmit] No text to generate SVG.");
        return;
    }

    try {
        await loadFont(fontName);
        if (!loadedFont) {
            console.error("[handleSubmit] loadedFont is null after await loadFont(fontName).");
            throw new Error("Font could not be loaded or parsed successfully for SVG generation.");
        }
        const svgMarkup = createSvg(text, loadedFont);

        const safeFileNameBase = [customer, desc, location]
            .map(s => s.replace(/\s+/g, "_").replace(/[^\w.-]/g, ''))
            .filter(s => s)
            .join("_");

        const safeFileName = safeFileNameBase ? `${safeFileNameBase}_engraving.svg` : "custom_engraving.svg";

        const blob = new Blob([svgMarkup], { type: "image/svg+xml" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = safeFileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        console.log(`[handleSubmit] SVG downloaded as ${safeFileName}`);
        const popup = document.getElementById('popupOverlay');
        popup.innerHTML = `<div>SVG Downloaded as ${safeFileName}!<br><small>(Click anywhere to dismiss)</small></div>`;
        popup.style.display = 'flex';
    } catch (err) {
        // Using a custom modal/message box instead of alert
        const popup = document.getElementById('popupOverlay');
        popup.innerHTML = `<div>Failed to generate SVG: ${err.message}<br><small>(Click to dismiss)</small></div>`;
        popup.style.display = 'flex';
        console.error("[handleSubmit] SVG generation error:", err);
    }
  }

  // Event Listeners
  document.getElementById('textInput').addEventListener('input', updatePreview);
  document.getElementById('fontSelector').addEventListener('change', updatePreview);
  window.addEventListener('DOMContentLoaded', () => {
    console.log("[DOMContentLoaded] Page loaded, initial updatePreview call.");
    // Initial call to updatePreview only if opentype is defined
    if (typeof opentype !== 'undefined') {
        updatePreview();
    } else {
        console.log("[DOMContentLoaded] opentype.js not loaded, initial preview update skipped.");
    }
  });
</script>

</body>
</html>
