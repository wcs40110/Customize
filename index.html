function updatePreview() {
  const text = textInput.value.trim();
  const font = fontSelector.value || 'Arial';

  previewCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
  previewCtx.fillStyle = 'white';
  previewCtx.fillRect(0, 0, previewCanvas.width, previewCanvas.height);

  previewCtx.fillStyle = 'black';
  previewCtx.font = `80px '${font}', Arial, sans-serif`;
  previewCtx.textAlign = 'center';
  previewCtx.textBaseline = 'middle';
  previewCtx.fillText(text, previewCanvas.width / 2, previewCanvas.height / 2);
}

// Run preview update on both text input and font selector change
textInput.addEventListener('input', updatePreview);
fontSelector.addEventListener('change', updatePreview);

// Add logs to track submit
async function handleSubmit() {
  const customer = document.getElementById('customerInput').value.trim();
  const desc = document.getElementById('descInput').value.trim();
  const location = document.getElementById('locationInput').value.trim();
  const text = textInput.value.trim();
  const font = fontSelector.value;

  if (!customer || !desc || !location || !text || !font) {
    alert('Please fill out all required fields.');
    return;
  }

  const safeFileName = `${customer}_${desc}_${location}.png`.replace(/\s+/g, '_');
  console.log('Submitting order:', { customer, desc, location, text, font, fileName: safeFileName });

  try {
    const blob = await new Promise(resolve => previewCanvas.toBlob(resolve, 'image/png'));
    if (!blob) throw new Error('Failed to create image blob.');

    const storageRef = storage.ref().child(`engraving_images/${safeFileName}`);

    console.log('Uploading image to Firebase Storage...');
    const uploadTask = await storageRef.put(blob);
    const downloadURL = await uploadTask.ref.getDownloadURL();

    console.log('Image uploaded. Saving order to Firestore...');
    await db.collection('orders').add({
      customer,
      desc,
      location,
      text,
      font,
      imageUrl: downloadURL,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });

    alert('Your engraving order and image have been submitted!');
    document.getElementById('customForm').reset();
    charCount.textContent = `${MAX_CHAR_LIMIT} characters remaining`;
    charCount.style.color = '#7f8c8d';
    updatePreview();

  } catch (error) {
    console.error('Submit error:', error);
    alert('Error submitting order: ' + error.message);
  }
}
