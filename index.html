<script src="https://cdn.jsdelivr.net/npm/opentype.js@latest/dist/opentype.min.js"></script>
</head>
<body>
<script>
  // IMMEDIATE CHECK FOR OPENTYPE.JS
  if (typeof opentype === 'undefined') {
    console.error("CRITICAL: opentype.js library did NOT load!");
    alert("CRITICAL: opentype.js did NOT load! Font features will not work. Check the browser console (Network tab) for issues loading 'opentype.min.js' from cdn.jsdelivr.net.");
    // Display error prominently on the page
    document.addEventListener('DOMContentLoaded', () => {
      const previewDiv = document.getElementById('svgPreview');
      if (previewDiv) {
        previewDiv.innerHTML = "<div style='color: red; font-weight: bold; padding: 10px;'>CRITICAL ERROR: opentype.js library failed to load. This is essential for font operations. Please check your browser's Network tab in the developer tools for errors related to 'opentype.min.js'. Ensure your internet connection is active and not blocking cdn.jsdelivr.net.</div>";
      }
      // Disable form
      const form = document.getElementById('customForm');
      if (form) {
        form.querySelectorAll('input, textarea, select, button').forEach(el => el.disabled = true);
      }
    });
  } else {
    console.log("SUCCESS: opentype.js library seems to be loaded.");
  }

  const fontUrls = {
    "Satisfy": "https://tiny-florentine-e8dbd9.netlify.app/satisfy-regular.ttf",
    "Righteous": "https://tiny-florentine-e8dbd9.netlify.app/righteous-regular.ttf",
    "Grand Hotel": "https://tiny-florentine-e8dbd9.netlify.app/grandhotel-regular.ttf",
    "Short Stack": "https://tiny-florentine-e8dbd9.netlify.app/shortstack-regular.ttf",
    "Love Ya Like A Sister": "https://tiny-florentine-e8dbd9.netlify.app/loveyalikeasister-regular.ttf",
    "Ribeye Marrow": "https://tiny-florentine-e8dbd9.netlify.app/ribeyemarrow-regular.ttf"
  };

  let loadedFont = null;
  let currentFontName = null;

  async function loadFont(fontName) {
    console.log(`[loadFont] Attempting to load font: ${fontName}`);
    if (typeof opentype === 'undefined') {
      const errorMsg = "[loadFont] CRITICAL: opentype.js is not defined. Cannot proceed.";
      console.error(errorMsg);
      document.getElementById('svgPreview').innerHTML = `<div style="color: red;">${errorMsg}</div>`;
      throw new Error("opentype.js is not defined inside loadFont.");
    }

    if (fontName === currentFontName && loadedFont) {
      console.log(`[loadFont] Using cached font: ${fontName}`);
      return;
    }

    const url = fontUrls[fontName];
    if (!url) {
      const errorMsg = `[loadFont] Font URL not found for: ${fontName}`;
      console.error(errorMsg);
      document.getElementById('svgPreview').innerHTML = `<div style="color: red;">${errorMsg}</div>`;
      throw new Error(errorMsg);
    }

    console.log(`[loadFont] Fetching URL: ${url}`);
    try {
      const res = await fetch(url);
      console.log(`[loadFont] Fetch response for ${fontName}: Status ${res.status}, OK: ${res.ok}`);
      if (!res.ok) {
        throw new Error(`HTTP error! status: ${res.status} for ${url}`);
      }
      const fontBuffer = await res.arrayBuffer();
      console.log(`[loadFont] Font buffer received for ${fontName}, length: ${fontBuffer.byteLength} bytes.`);
      if (fontBuffer.byteLength < 100) { // Arbitrary small number, real fonts are larger
          console.warn(`[loadFont] WARNING: Font buffer for ${fontName} is very small. Is the font file correct/complete?`);
      }
      loadedFont = opentype.parse(fontBuffer);
      console.log(`[loadFont] Font parsed successfully: ${fontName}`);
      currentFontName = fontName;
    } catch (error) {
      console.error(`[loadFont] Failed to load or parse font '${fontName}':`, error);
      document.getElementById('svgPreview').innerHTML = `<div style="color: red;">Error loading font '${fontName}': ${error.message}. Check console for more details.</div>`;
      throw error; // Re-throw to be caught by updatePreview or handleSubmit
    }
  }

  function createSvg(text, font) {
    // ... (rest of your createSvg function is likely fine)
    const fontSize = 80;
    const width = 600;
    const height = 150;
    console.log(`[createSvg] Creating SVG for text "${text}" with font ${font.names.fontFamily.en}`);
    const path = font.getPath(text, 0, 0, fontSize); // Assuming baseline at y=0
    const pathData = path.toPathData(2);
    const svgContent = `
      <svg xmlns="http://www.w3.org/2000/svg" width="${width}" height="${height}" viewBox="0 -70 ${width} ${height}">
        <path d="${pathData}" fill="black"/>
      </svg>
    `;
    console.log("[createSvg] SVG markup generated.");
    return svgContent;
  }

  async function updatePreview() {
    console.log("[updatePreview] Called.");
    const text = document.getElementById('textInput').value.trim();
    const fontName = document.getElementById('fontSelector').value;
    const preview = document.getElementById('svgPreview');

    if (!text) {
      preview.innerHTML = "Enter text above to preview.";
      console.log("[updatePreview] No text, preview set to instruction.");
      return;
    }

    preview.innerHTML = `Loading font '${fontName}' and generating preview...`; // Feedback during load
    console.log(`[updatePreview] Text: "${text}", Font: "${fontName}"`);
    try {
      await loadFont(fontName);
      const svgMarkup = createSvg(text, loadedFont);
      preview.innerHTML = svgMarkup;
      console.log("[updatePreview] SVG preview updated.");
    } catch (err) {
      console.error("[updatePreview] Error during preview update:", err);
      // loadFont already updates the preview on its own error, but this is a fallback
      if (!preview.innerHTML.includes("Error loading font")) { // Avoid overwriting specific error from loadFont
        preview.innerHTML = `<div style="color: red;">Failed to update preview: ${err.message}. Check console.</div>`;
      }
    }
  }

  async function handleSubmit() {
    // ... (your handleSubmit function, consider adding logs here too if needed)
    console.log("[handleSubmit] Form submitted.");
    // ...
    const text = document.getElementById('textInput').value.trim(); // Ensure text is defined
    const fontName = document.getElementById('fontSelector').value; // Ensure fontName is defined

    if (!text) {
        alert("Enter some text to generate SVG.");
        console.log("[handleSubmit] No text to generate SVG.");
        return;
    }

    try {
        await loadFont(fontName); // Make sure font is loaded
        // ... rest of your handleSubmit
        const customer = document.getElementById('customerInput').value.trim();
        const desc = document.getElementById('descInput').value.trim();
        const location = document.getElementById('locationInput').value.trim();
        const svgMarkup = createSvg(text, loadedFont);

        const safeFileName = [customer, desc, location]
            .map(s => s.replace(/\s+/g, "_").replace(/[^\w.-]/g, ''))
            .filter(s => s) // Remove empty parts
            .join("_") + (customer || desc || location ? "_" : "") + "engraving.svg"; // Ensure a base name if all are empty

        const blob = new Blob([svgMarkup], { type: "image/svg+xml" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = safeFileName || "custom_engraving.svg"; // Fallback filename
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        console.log(`[handleSubmit] SVG downloaded as ${safeFileName}`);
        document.getElementById('popupOverlay').style.display = 'flex';
    } catch (err) {
        alert("Failed to generate SVG: " + err.message);
        console.error("[handleSubmit] SVG generation error:", err);
    }
  }

  // Event Listeners
  document.getElementById('textInput').addEventListener('input', updatePreview);
  document.getElementById('fontSelector').addEventListener('change', updatePreview);
  window.addEventListener('DOMContentLoaded', () => {
    console.log("[DOMContentLoaded] Page loaded, initial updatePreview call.");
    updatePreview(); // Initial call
  });

</script>
</body>
</html>
